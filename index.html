<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathao Smart Bulk Uploader</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ZOOM LEVEL 90% */
        body { font-family: 'Roboto', sans-serif; background: #f9f9f9; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; zoom: 90%; }
        
        /* HEADER */
        .header { background: #fff; padding: 12px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); z-index: 20; }
        .logo { color: #ef3d2d; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .controls { display: flex; gap: 10px; align-items: center; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; font-weight: 500; cursor: pointer; transition: 0.2s; font-size: 13px; display: inline-flex; align-items: center; gap: 5px; white-space: nowrap; }
        .btn-red { background: #ef3d2d; color: white; } .btn-red:hover { background: #d32f2f; }
        .btn-blue { background: #1976d2; color: white; } .btn-blue:hover { background: #1565c0; }
        .btn-green { background: #2e7d32; color: white; } .btn-green:hover { background: #1b5e20; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        input[type="file"], select { font-size: 13px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; }

        /* STATS BAR */
        .stats-bar { background: #fff3f2; color: #d32f2f; padding: 8px 20px; font-size: 13px; font-weight: 600; display: flex; justify-content: space-between; border-bottom: 1px solid #ffcdd2; flex-shrink: 0; z-index: 15; position: relative; }
        .stats-right { display: flex; gap: 15px; }

        /* TABLE */
        .table-wrapper { flex: 1; overflow: auto; padding: 0; background: #f1f3f6; position: relative; padding-bottom: 250px; }
        .table-card { background: white; border-radius: 0; box-shadow: none; display: inline-block; min-width: 100%; margin-top: 0; border-top: 1px solid #e0e0e0; }
        table { width: auto; min-width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
        thead { position: sticky; top: 0; z-index: 10; }
        thead tr { background-color: #f5f5f5; height: 45px; }
        th { position: sticky; top: 0; background: #f5f5f5; z-index: 10; text-align: left; padding: 0 10px; color: #444; font-weight: 700; font-size: 12px; border-bottom: 2px solid #e0e0e0; border-right: 1px solid #e0e0e0; white-space: nowrap; }
        td { border-bottom: 1px solid #eee; border-right: 1px solid #eee; padding: 0; vertical-align: top; background: #fff; position: relative; }
        
        /* INPUTS */
        input.cell-input { width: 100%; height: 40px; border: none; outline: none; padding: 0 10px; font-size: 13px; background: transparent; font-family: 'Roboto', sans-serif; box-sizing: border-box; }
        input.cell-input:focus { background: #e3f2fd; box-shadow: inset 0 0 0 2px #2196f3; }
        textarea.cell-textarea { width: 100%; min-width: 250px; height: 100%; min-height: 50px; border: none; outline: none; padding: 8px; font-size: 12px; font-family: 'Roboto', sans-serif; resize: none; overflow: hidden; background: transparent; line-height: 1.3; }
        textarea.cell-textarea:focus { background: #e3f2fd; }

        /* VALIDATION & STATUS */
        .error-cell { background-color: #ffebee !important; border: 2px solid #ef5350 !important; }
        .auto-filled { background-color: #e8f5e9 !important; }
        .row-success { background-color: #e8f5e9 !important; }
        .row-error { background-color: #ffebee !important; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #ef3d2d; border-radius: 50%; width: 12px; height: 12px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* AUTOCOMPLETE */
        .autocomplete-wrapper { position: relative; width: 100%; height: 100%; }
        .autocomplete-list { position: absolute; border: 1px solid #ddd; border-top: none; z-index: 100; top: 100%; left: 0; right: 0; background-color: #fff; max-height: 250px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: none; border-radius: 0 0 4px 4px; }
        .autocomplete-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f1f1f1; font-size: 13px; color: #333; }
        .autocomplete-item:hover, .autocomplete-active { background-color: #e3f2fd; }
        .autocomplete-active { background-color: #1976d2 !important; color: #ffffff !important; }
        .autocomplete-active strong { color: #ffeb3b !important; }
        .autocomplete-item strong { color: #ef3d2d; }

        /* TOAST */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .toast { background: #323232; color: white; padding: 12px 24px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; opacity: 0; transform: translateY(20px); transition: 0.3s ease; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: #2e7d32; }
        .toast.error { background: #c62828; }
        .toast.warning { background: #f9a825; color: #000; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">
        <span style="background:#ef3d2d; color:white; padding:2px 8px; border-radius:4px; font-size:14px;">BULK</span> 
        Pathao Uploader
    </div>
    <div class="controls">
        <select id="storeSelect" onchange="changeStore()">
            <option value="">Loading Stores...</option>
        </select>
        <input type="file" id="uploadFile" accept=".xlsx, .xls">
        <select id="sheetSelect" style="display:none;"></select>
        <button id="loadBtn" class="btn btn-red" style="display:none;" onclick="processSheet()">Load Data</button>
        <button id="copyBtn" class="btn btn-green" style="display:none;" onclick="copyToClipboard()">üìã Copy</button>
        <button id="uploadApiBtn" class="btn btn-blue" style="display:none;" onclick="uploadToPathao()">‚òÅ Send to Pathao</button>
    </div>
</div>

<div class="stats-bar">
    <span id="storeInfo">Store: None Selected</span>
    <div class="stats-right">
        <span>üì¶ Parcels: <span id="totalCount">0</span></span>
        <span>üí∞ Total: <span id="totalAmount">0</span> Tk</span>
        <span id="apiStatus" style="color:#555;">Connecting...</span>
    </div>
</div>

<div class="table-wrapper">
    <div class="table-card">
        <table id="dataTable">
            <thead>
                <tr>
                    <th style="width: 120px;">Status / CID</th>
                    <th style="width: 120px;">StoreName</th>
                    <th style="width: 140px;">MerchantOrderId</th>
                    <th style="width: 160px;">RecipientName(*)</th>
                    <th style="width: 130px;">RecipientPhone(*)</th>
                    <th style="width: 300px;">RecipientAddress(*)</th>
                    <th style="width: 160px;">RecipientCity(*)</th>
                    <th style="width: 200px;">RecipientZone(*)</th>
                    <th style="width: 100px;">RecipientArea</th>
                    <th style="width: 120px;">AmountToCollect(*)</th>
                    <th style="width: 80px;">ItemQuantity</th>
                    <th style="width: 80px;">ItemWeight</th>
                    <th style="width: 200px;">ItemDesc</th>
                    <th style="width: 150px;">SpecialInstruction</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="14" style="text-align:center; padding: 50px; color:#888;">No data loaded. Please upload a file.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="toast-container"></div>

<script>
    // Paste your Web App URL Here
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbygCBFket7MXDDz2DnkDinXg_8zUq76rQCtW_maszf_dS86XNHx8TmldO_M7A-TItFWNw/exec";

    let workbook;
    let citiesCache = []; 
    let zonesCache = {};  
    let tableData = [];
    let CURRENT_STORE_ID = null;
    let CURRENT_STORE_NAME = "Select Store";

    window.onload = async function() {
        try {
            const sResp = await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "get_stores" }) });
            const sData = await sResp.json();
            const storeSelect = document.getElementById('storeSelect');
            storeSelect.innerHTML = ""; 
            if(sData.status === "success" && sData.data.data.length > 0) {
                sData.data.data.forEach((store, index) => {
                    const opt = document.createElement('option');
                    opt.value = store.store_id; opt.innerText = store.store_name; storeSelect.appendChild(opt);
                    if(index === 0) {
                        CURRENT_STORE_ID = store.store_id;
                        CURRENT_STORE_NAME = store.store_name;
                        document.getElementById('storeInfo').innerHTML = `Store: <b>${CURRENT_STORE_NAME}</b>`;
                    }
                });
            } else { storeSelect.innerHTML = "<option>No Store Found</option>"; }
        } catch(e) {}

        try {
            const cResp = await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "get_cities" }) });
            const cData = await cResp.json();
            if(cData.status === "success") {
                citiesCache = cData.data.data;
                document.getElementById('apiStatus').innerHTML = '<span style="color:green">‚úî Ready</span>';
                fetchZones(1); fetchZones(2);
            }
        } catch(e) { document.getElementById('apiStatus').innerText = "Net Error"; }
        document.addEventListener('click', function(e) { closeAllLists(e.target); });
    };

    function changeStore() {
        const select = document.getElementById('storeSelect');
        CURRENT_STORE_ID = select.value;
        CURRENT_STORE_NAME = select.options[select.selectedIndex].text;
        document.getElementById('storeInfo').innerHTML = `Store: <b>${CURRENT_STORE_NAME}</b>`;
        const rows = document.querySelectorAll("#tableBody tr");
        rows.forEach(tr => { if(tr.cells.length > 1) tr.cells[1].innerText = CURRENT_STORE_NAME; });
    }

    async function fetchZones(cityId) {
        if(zonesCache[cityId]) return zonesCache[cityId];
        try {
            const resp = await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "get_zones", city_id: cityId }) });
            const data = await resp.json();
            if(data.status === "success") { zonesCache[cityId] = data.data.data; return zonesCache[cityId]; }
        } catch(e) {}
        return [];
    }

    document.getElementById('uploadFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = new Uint8Array(evt.target.result);
            workbook = XLSX.read(data, {type: 'array'});
            const select = document.getElementById('sheetSelect');
            select.innerHTML = "";
            workbook.SheetNames.forEach(sheet => {
                const opt = document.createElement('option');
                opt.value = sheet; opt.innerText = sheet; select.appendChild(opt);
            });
            select.style.display = 'inline-block';
            document.getElementById('loadBtn').style.display = 'inline-block';
        };
        reader.readAsArrayBuffer(file);
    });

    async function processSheet() {
        const sheetName = document.getElementById('sheetSelect').value;
        const ws = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(ws, {header: 1});
        let headerIdx = -1;
        for(let i=0; i<Math.min(jsonData.length, 20); i++) {
            const rowStr = JSON.stringify(jsonData[i]).toLowerCase();
            if(rowStr.includes('phone') && (rowStr.includes('name') || rowStr.includes('address'))) { headerIdx = i; break; }
        }
        if (headerIdx === -1) { showToast("Header not found!", "error"); return; }
        const keys = jsonData[headerIdx].map(k => String(k).toLowerCase().replace(/[^a-z0-9]/g, ''));
        const rawData = jsonData.slice(headerIdx + 1);
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        tableData = [];
        const getVal = (row, keyPart) => {
            const idx = keys.findIndex(k => k.includes(keyPart));
            return idx !== -1 ? row[idx] : "";
        };
        
        const cityKeywords = {
            "Dhaka": ["dhaka", "‡¶¢‡¶æ‡¶ï‡¶æ", "keraniganj", "savar", "narayanganj", "gazipur", "‡¶®‡¶æ‡¶∞‡¶æ‡ßü‡¶£‡¶ó‡¶û‡ßç‡¶ú", "‡¶ó‡¶æ‡¶ú‡ßÄ‡¶™‡ßÅ‡¶∞", "‡¶∏‡¶æ‡¶≠‡¶æ‡¶∞", "‡¶ï‡ßá‡¶∞‡¶æ‡¶®‡ßÄ‡¶ó‡¶û‡ßç‡¶ú"],
            "Chittagong": ["chittagong", "ctg", "chattogram", "‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ"],
            "Sylhet": ["sylhet", "‡¶∏‡¶ø‡¶≤‡ßá‡¶ü"],
            "Rajshahi": ["rajshahi", "‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ"],
            "Khulna": ["khulna", "‡¶ñ‡ßÅ‡¶≤‡¶®‡¶æ"],
            "Barishal": ["barishal", "barisal", "‡¶¨‡¶∞‡¶ø‡¶∂‡¶æ‡¶≤"],
            "Rangpur": ["rangpur", "‡¶∞‡¶Ç‡¶™‡ßÅ‡¶∞"],
            "Comilla": ["comilla", "cumilla", "‡¶ï‡ßÅ‡¶Æ‡¶ø‡¶≤‡ßç‡¶≤‡¶æ"],
            "Mymensingh": ["mymensingh", "‡¶Æ‡ßü‡¶Æ‡¶®‡¶∏‡¶ø‡¶Ç‡¶π"],
            "Jessore": ["jessore", "‡¶Ø‡¶∂‡ßã‡¶∞"],
            "Bogra": ["bogra", "‡¶¨‡¶ó‡ßÅ‡ßú‡¶æ"],
            "Dinajpur": ["dinajpur", "‡¶¶‡¶ø‡¶®‡¶æ‡¶ú‡¶™‡ßÅ‡¶∞"],
            "Feni": ["feni", "‡¶´‡ßá‡¶®‡ßÄ"],
            "Tangail": ["tangail", "‡¶ü‡¶æ‡¶ô‡ßç‡¶ó‡¶æ‡¶á‡¶≤"]
        };

        for (let i = 0; i < rawData.length; i++) {
            const row = rawData[i];
            let phone = cleanPhone(getVal(row, 'phone'));
            let amount = cleanAmount(getVal(row, 'amount'));
            let rawAddress = String(getVal(row, 'address') || "");
            let address = rawAddress.replace(/[\r\n\t]+/g, " ").trim();
            let merchantId = String(getVal(row, 'merchant') || "");
            let name = String(getVal(row, 'name') || "");
            let desc = String(getVal(row, 'product') || getVal(row, 'desc') || ""); 
            let qty = getVal(row, 'quantity') || getVal(row, 'qty') || 1;

            if (!phone && !amount && !address) continue;

            let detectedCityId = ""; let detectedCityName = "";
            const addrLower = address.toLowerCase();
            const foundCity = citiesCache.find(c => addrLower.includes(c.city_name.toLowerCase()));
            if (foundCity) {
                detectedCityId = foundCity.city_id; detectedCityName = foundCity.city_name;
            } else {
                for (const [engName, keywords] of Object.entries(cityKeywords)) {
                    if (keywords.some(k => addrLower.includes(k))) {
                        const targetCity = citiesCache.find(c => c.city_name.toLowerCase() === engName.toLowerCase());
                        if(targetCity) { detectedCityId = targetCity.city_id; detectedCityName = targetCity.city_name; break; }
                    }
                }
            }

            // --- RESTORED DEFAULT DHAKA LOGIC ---
            if (!detectedCityId) {
                detectedCityId = 1; // Dhaka ID
                detectedCityName = "Dhaka";
            }

            const rowId = i;
            const rowObj = {
                id: rowId,
                merchantId, name, phone, address, amount, qty, desc, specialInstruction: "", 
                cityId: detectedCityId, cityName: detectedCityName, zoneId: "", zoneName: "",
                status: "Pending"
            };
            tableData.push(rowObj);

            const phoneClass = (phone.length === 11) ? "" : "error-cell";
            const cityClass = (detectedCityId) ? "" : "error-cell";
            
            const tr = document.createElement('tr');
            tr.id = `row-${rowId}`;
            tr.innerHTML = `
                <td id="status-cell-${rowId}">Parcel</td>
                <td>${CURRENT_STORE_NAME}</td>
                <td><input class="cell-input" value="${merchantId}" onchange="updateData(${rowId}, 'merchantId', this.value)"></td>
                <td><input class="cell-input" value="${name}" onchange="updateData(${rowId}, 'name', this.value)"></td>
                <td><input class="cell-input ${phoneClass}" value="${phone}" maxlength="11" oninput="validatePhoneUI(this, ${rowId})"></td>
                <td style="height: auto;">
                    <textarea class="cell-textarea" onchange="updateData(${rowId}, 'address', this.value); autoDetectZone(${rowId});">${address}</textarea>
                </td>
                <td>
                    <div class="autocomplete-wrapper">
                        <input class="cell-input ${cityClass}" id="city-input-${rowId}" value="${detectedCityName}" 
                               placeholder="Type city..." autocomplete="off">
                        <div class="autocomplete-list" id="city-list-${rowId}"></div>
                    </div>
                </td>
                <td>
                    <div class="autocomplete-wrapper">
                        <input class="cell-input error-cell" id="zone-input-${rowId}" 
                               placeholder="Type zone..." autocomplete="off">
                        <div class="autocomplete-list" id="zone-list-${rowId}"></div>
                    </div>
                </td>
                <td><input class="cell-input" placeholder="Opt."></td>
                <td><input class="cell-input" value="${amount}" onchange="updateStats()"></td>
                <td><input class="cell-input" value="${qty}" style="width:100%"></td>
                <td>0.5</td>
                <td><input class="cell-input" value="${desc}" onchange="updateData(${rowId}, 'desc', this.value)"></td>
                <td><input class="cell-input" onchange="updateData(${rowId}, 'specialInstruction', this.value)" placeholder=""></td>
            `;
            tbody.appendChild(tr);
            setupCityAutocomplete(rowId); setupZoneAutocomplete(rowId); autoDetectZone(rowId);
        }
        document.getElementById('copyBtn').style.display = 'inline-block';
        document.getElementById('uploadApiBtn').style.display = 'inline-block';
        updateStats();
        showToast("Data Loaded Successfully", "success");
    }

    function setupCityAutocomplete(rowId) {
        const input = document.getElementById(`city-input-${rowId}`);
        const listDiv = document.getElementById(`city-list-${rowId}`);
        let currentFocus = -1;
        const updateList = (val) => {
            closeAllLists();
            if (!val) return;
            listDiv.innerHTML = ""; listDiv.style.display = "block"; currentFocus = -1;
            citiesCache.forEach(city => {
                if (city.city_name.toLowerCase().includes(val.toLowerCase())) {
                    const item = document.createElement("div");
                    item.className = "autocomplete-item";
                    item.innerHTML = city.city_name.replace(new RegExp(`(${val})`, "gi"), "<strong>$1</strong>");
                    item.addEventListener("click", () => selectItem(city));
                    listDiv.appendChild(item);
                }
            });
        };
        input.addEventListener('input', () => updateList(input.value));
        input.addEventListener('click', (e) => { e.stopPropagation(); updateList(input.value || " "); });
        input.addEventListener("keydown", function(e) {
            let x = listDiv.getElementsByTagName("div");
            if (e.keyCode == 40) { currentFocus++; addActive(x); } 
            else if (e.keyCode == 38) { currentFocus--; addActive(x); } 
            else if (e.keyCode == 13) { e.preventDefault(); if (currentFocus > -1 && x) x[currentFocus].click(); else if (x && x.length > 0) x[0].click(); }
        });
        function addActive(x) {
            if (!x) return false; removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0; if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("autocomplete-active"); x[currentFocus].scrollIntoView({block: 'nearest'});
        }
        function removeActive(x) { for (let i = 0; i < x.length; i++) x[i].classList.remove("autocomplete-active"); }
        function selectItem(city) {
            input.value = city.city_name; tableData[rowId].cityId = city.city_id; tableData[rowId].cityName = city.city_name;
            input.classList.remove('error-cell');
            document.getElementById(`zone-input-${rowId}`).value = ""; tableData[rowId].zoneId = "";
            listDiv.style.display = "none"; autoDetectZone(rowId);
            const nextInput = document.getElementById(`city-input-${rowId + 1}`); if(nextInput) nextInput.focus();
        }
    }

    async function setupZoneAutocomplete(rowId) {
        const input = document.getElementById(`zone-input-${rowId}`);
        const listDiv = document.getElementById(`zone-list-${rowId}`);
        let currentFocus = -1;
        const handler = async function(e) {
            e.stopPropagation(); if (e.type === 'keydown') return;
            const val = input.value; const cityId = tableData[rowId].cityId; if(!cityId) return;
            const zones = await fetchZones(cityId);
            closeAllLists(); listDiv.innerHTML = ""; listDiv.style.display = "block"; currentFocus = -1;
            const matches = zones.filter(z => z.zone_name.toLowerCase().includes(val.toLowerCase()));
            const displayZones = val ? matches : zones;
            displayZones.forEach(z => {
                const item = document.createElement("div"); item.className = "autocomplete-item";
                item.innerHTML = val ? z.zone_name.replace(new RegExp(`(${val})`, "gi"), "<strong>$1</strong>") : z.zone_name;
                item.addEventListener("click", () => {
                    input.value = z.zone_name; tableData[rowId].zoneId = z.zone_id; tableData[rowId].zoneName = z.zone_name;
                    input.classList.remove('error-cell'); input.classList.add('auto-filled'); listDiv.style.display = "none";
                    const nextInput = document.getElementById(`zone-input-${rowId + 1}`); if(nextInput) nextInput.focus();
                });
                listDiv.appendChild(item);
            });
        };
        input.addEventListener('input', handler); input.addEventListener('click', handler);
        input.addEventListener("keydown", function(e) {
            let x = listDiv.getElementsByTagName("div");
            if (e.keyCode == 40) { currentFocus++; addActive(x); } 
            else if (e.keyCode == 38) { currentFocus--; addActive(x); } 
            else if (e.keyCode == 13) { e.preventDefault(); if (currentFocus > -1 && x) x[currentFocus].click(); else if (x && x.length > 0) x[0].click(); }
        });
        function addActive(x) { if (!x) return false; removeActive(x); if (currentFocus >= x.length) currentFocus = 0; if (currentFocus < 0) currentFocus = (x.length - 1); x[currentFocus].classList.add("autocomplete-active"); x[currentFocus].scrollIntoView({block: 'nearest'}); }
        function removeActive(x) { for (let i = 0; i < x.length; i++) x[i].classList.remove("autocomplete-active"); }
    }

    function closeAllLists(elmnt) {
        const x = document.getElementsByClassName("autocomplete-list");
        for (let i = 0; i < x.length; i++) { if (elmnt != x[i] && elmnt != x[i].previousElementSibling) { x[i].innerHTML = ""; x[i].style.display = "none"; } }
    }

    async function autoDetectZone(rowId) {
        const row = tableData[rowId]; if(!row.cityId) return;
        const zones = await fetchZones(row.cityId);
        const sortedZones = [...zones].sort((a,b) => b.zone_name.length - a.zone_name.length);
        const matched = sortedZones.find(z => row.address.toLowerCase().includes(z.zone_name.toLowerCase()));
        const zoneInput = document.getElementById(`zone-input-${rowId}`);
        if (matched) {
            row.zoneId = matched.zone_id; zoneInput.value = matched.zone_name;
            zoneInput.classList.remove('error-cell'); zoneInput.classList.add('auto-filled');
        } else { zoneInput.classList.remove('auto-filled'); zoneInput.classList.add('error-cell'); }
    }

    function validatePhoneUI(input, idx) {
        let val = input.value.replace(/[^0-9]/g, ''); if (val.length > 11) val = val.substring(0, 11);
        input.value = val; tableData[idx].phone = val;
        if (val.length === 11) input.classList.remove('error-cell'); else input.classList.add('error-cell');
    }
    function updateData(index, field, value) { tableData[index][field] = value; }
    function cleanPhone(p) {
        if(!p) return ""; let s = String(p).replace(/[^0-9]/g,'');
        if (String(p).includes('E') || String(p).includes('e')) s = Number(p).toLocaleString('fullwide', {useGrouping:false});
        if(s.startsWith('880')) s = s.substring(2); if(s.length > 0 && !s.startsWith('0')) s='0'+s;
        return s.substring(0,11);
    }
    function cleanAmount(a) { return parseFloat(String(a).replace(/,/g,'')) || 0; }
    function updateStats() {
        const rows = document.querySelectorAll("#tableBody tr"); let total = 0;
        rows.forEach((r, i) => { const amt = r.cells[9].querySelector('input').value; total += parseFloat(amt) || 0; tableData[i].amount = amt; });
        document.getElementById('totalCount').innerText = rows.length;
        document.getElementById('totalAmount').innerText = total.toLocaleString();
    }
    function copyToClipboard() {
        const rows = document.querySelectorAll("#tableBody tr"); let clipboardText = "";
        rows.forEach((tr, idx) => {
            const inputs = tr.querySelectorAll("input, textarea"); let rowData = [];
            rowData.push("Parcel"); rowData.push(CURRENT_STORE_NAME);
            rowData.push(inputs[0].value); rowData.push(inputs[1].value); rowData.push(inputs[2].value); 
            rowData.push(inputs[3].value.replace(/(\r\n|\n|\r)/gm, " ")); 
            rowData.push(inputs[4].value); rowData.push(inputs[5].value); rowData.push(inputs[6].value); 
            rowData.push(inputs[7].value); rowData.push(inputs[8].value); rowData.push("0.5");           
            rowData.push(inputs[9].value); rowData.push(inputs[10].value);
            clipboardText += rowData.join("\t") + "\n";
        });
        navigator.clipboard.writeText(clipboardText).then(() => { showToast("‚úÖ Copied! Ready to paste in Pathao.", "success"); }).catch(err => showToast("Failed to copy", "error"));
    }

    // --- UPLOAD WITH CHUNKING (SUPER FAST) ---
    async function uploadToPathao() {
        if(!CURRENT_STORE_ID) { showToast("Store ID not found. Please refresh.", "error"); return; }
        const errors = document.querySelectorAll('.error-cell');
        if (errors.length > 0) { showToast(`‚ö†Ô∏è Please fix ${errors.length} red error boxes first!`, "warning"); errors[0].scrollIntoView({behavior: "smooth", block: "center"}); return; }

        const btn = document.getElementById('uploadApiBtn');
        const originalText = btn.innerHTML; const originalClass = btn.className;
        btn.disabled = true; btn.innerHTML = '<span class="loader"></span> Processing...'; 

        let hasError = false;
        
        // Prepare ALL valid rows
        const pendingRows = tableData.filter((row, i) => {
            const tr = document.getElementById(`row-${i}`);
            // Check validation again just in case
            if(!row.phone || row.phone.length !== 11 || !row.cityId || !row.zoneId) return false;
            // Skip already done
            if(tr.className.includes("row-success")) return false;
            
            // UI Update: Set status to sending
            const statusCell = document.getElementById(`status-cell-${i}`);
            statusCell.innerHTML = `<span class="loader"></span> Sending`;
            return true;
        });

        if(pendingRows.length === 0) {
            btn.disabled = false; btn.innerHTML = originalText;
            showToast("No pending orders to send.", "warning");
            return;
        }

        // BATCH SIZE: 50 (Pathao can likely handle this via GAS)
        const BATCH_SIZE = 50;

        for (let i = 0; i < pendingRows.length; i += BATCH_SIZE) {
            const chunk = pendingRows.slice(i, i + BATCH_SIZE);
            
            // Map rows to Pathao Payload format
            const payloadData = chunk.map(row => ({
                store_id: Number(CURRENT_STORE_ID), // Ensure number
                merchant_order_id: row.merchantId,
                recipient_name: row.name,
                recipient_phone: row.phone,
                recipient_address: row.address,
                recipient_city: Number(row.cityId),
                recipient_zone: Number(row.zoneId),
                amount_to_collect: parseInt(row.amount),
                item_quantity: parseInt(row.qty),
                item_type: 2, 
                delivery_type: 48, 
                item_weight: 0.5,
                item_description: row.desc,
                special_instruction: row.specialInstruction || "" 
            }));

            try {
                // Send ONE BIG REQUEST for 50 orders to Code.gs
                const response = await fetch(GAS_API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "create_bulk_orders", data: payloadData })
                });
                const result = await response.json();

                if (result.status === "success" && Array.isArray(result.data)) {
                    // Result.data contains array of statuses matching the chunk order
                    result.data.forEach((res, idx) => {
                        const originalRowIndex = chunk[idx].id;
                        const tr = document.getElementById(`row-${originalRowIndex}`);
                        const statusCell = document.getElementById(`status-cell-${originalRowIndex}`);
                        
                        if (res.success) {
                            statusCell.innerHTML = `<span style='color:green; font-weight:bold;'>‚úî ${res.consignment_id}</span>`;
                            tr.className = "row-success";
                        } else {
                            statusCell.innerHTML = `<span style='color:red; cursor:pointer' title='${res.message}'>‚úñ Fail</span>`;
                            tr.className = "row-error";
                            hasError = true;
                        }
                    });
                } else {
                    hasError = true; // Overall failure
                }
            } catch (e) {
                console.error(e);
                hasError = true;
            }
        }

        btn.disabled = false;
        if (!hasError) { btn.innerText = "Successfully"; btn.className = "btn btn-green"; } 
        else { btn.innerText = "Fail"; btn.className = "btn btn-red"; }

        setTimeout(() => { btn.innerHTML = originalText; btn.className = originalClass; }, 3000);
        showToast("Process Finished", hasError ? "warning" : "success");
    }

    function showToast(message, type = "") {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.innerHTML = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }
</script>

</body>
</html>
